version: "3.9"

services:
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"     # AMQP port
      - "15672:15672"   # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Message Queue Service
  messagequeue:
    build:
      context: ./messageQueue
      dockerfile: Dockerfile
    container_name: messagequeue
    expose:
      - "3001"
    env_file:
      - ./messageQueue/.env
    environment:
      PORT: 3001
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  # Email Server Service
  emailserver:
    build:
      context: ./emailServer
      dockerfile: Dockerfile
    container_name: emailserver
    expose:
      - "3002"
    env_file:
      - ./emailServer/.env
    environment:
      PORT: 3002
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  # Backend API Service
  app:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    env_file:
      - ./backend/.env
    environment:
      PORT: 3000
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    expose:
      - "3000"
    volumes:
      - ./backend/uploads:/app/uploads
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Cronjob Service - Clear Pending Earnings
  cronjob:
    build:
      context: ./backend
      dockerfile: Dockerfile.cronjob
    container_name: cronjob
    env_file:
      - ./backend/.env
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./backend/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped

volumes:
  rabbitmq_data:
